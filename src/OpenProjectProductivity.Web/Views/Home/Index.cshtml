@model List<OpenProductivity.Web.DTOs.MemberStatisticDto>
@{
    ViewData["Title"] = "Project Dashboard";

    var selectedProjectId = ViewBag.ProjectId as int?;
    var selectedGoalPeriod = ViewBag.GoalPeriod as string;
    var projects = ViewBag.Projects as List<(int Id, string Name)>;
    var goalPeriods = ViewBag.GoalPeriods as List<string>;
}

<!-- Dashboard Filters -->
<form method="get" class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
    <div>
        <label class="label"><span class="label-text">Project</span></label>
        <select name="projectId" class="select select-bordered w-full">
            <option value="">Select Project</option>
            @foreach (var project in projects)
            {
                <option value="@project.Id" selected="@(selectedProjectId == project.Id)">
                    @project.Name
                </option>
            }
        </select>
    </div>
    <div>
        <label class="label"><span class="label-text">Goal Period</span></label>
        <select name="goalPeriod" class="select select-bordered w-full">
            <option value="">Select Goal Period</option>
            @foreach (var gp in goalPeriods)
            {
                <option value="@gp" selected="@(selectedGoalPeriod == gp)">
                    @gp
                </option>
            }
        </select>
    </div>
    <div class="flex items-end">
        <button type="submit" class="btn bg-black text-white hover:bg-orange-500 hover:text-black w-full">Find</button>
    </div>
</form>

<!-- Dashboard Table -->
@if (Model != null && Model.Any())
{
    <div class="overflow-x-auto bg-gray-100 shadow-lg rounded-lg p-5">
        <table id="memberTable" class="table table-zebra min-w-max w-full">
            <thead class="bg-black text-white">
                <tr>
                    <th class="text-center">Member Name</th>
                    <th class="text-center">User Stories</th>
                    <th class="text-center">Issues</th>
                    <th class="text-center">Completed Tasks</th>
                    <th class="text-center">Avg Duration</th>
                    <th class="text-center">Rework Count</th>
                    <th class="text-center">Action</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var member in Model)
                {
                    <tr>
                        <td>@member.MemberName</td>
                        <td class="text-center">@member.TotalUserStories</td>
                        <td class="text-center">@member.TotalIssues</td>
                        <td class="text-center">@member.CompletedTasks</td>
                        <td class="text-center">@Math.Round(member.AvgDurationDays, 2)</td>
                        <td class="text-center">@member.ReworkCount</td>
                        <td class="text-center">
                            <button class="btn btn-sm bg-black text-white view-task-btn hover:bg-orange-500 hover:text-black"
                                data-member-id="@member.MemberId" data-member-name="@member.MemberName"
                                data-project-id="@selectedProjectId" data-goal-period="@selectedGoalPeriod">
                                View Task
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else if (selectedProjectId != null && selectedGoalPeriod != null)
{
    <div class="alert alert-warning shadow-lg mt-6">
        <span>No data available for the selected project and goal period.</span>
    </div>
}

<!-- Modal (outside of any flex/scroll container) -->
<div id="taskDetailModal" class="fixed inset-0 hidden z-50 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white w-11/12 max-w-6xl max-h-[90vh] flex flex-col rounded-lg overflow-hidden relative">
        <div class="flex justify-between items-center border-b p-4">
            <h2 class="text-xl font-bold" id="modalTitle">Member Tasks</h2>
            <button id="closeModal" class="btn btn-sm btn-circle btn-ghost">✕</button>
        </div>
        <div id="modalContent" class="overflow-y-auto flex-1 p-4 custom-scrollbar">
            <p class="text-center text-gray-500">Loading...</p>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Initialize main table
            $('#memberTable').DataTable({
                paging: true,
                searching: true,
                ordering: true,
                info: true,
                pageLength: 10,
                responsive: true,
                columnDefs: [{ orderable: false, targets: 6 }]
            });

            // Handle View Task button click
            $(document).on('click', '.view-task-btn', function () {
                var memberId = $(this).data('member-id');
                var memberName = $(this).data('member-name');
                var projectId = $(this).data('project-id');
                var goalPeriod = $(this).data('goal-period');

                $('#modalTitle').text(memberName + "'s Tasks");
                $('#modalContent').html('<p class="text-center text-gray-500">Loading...</p>');
                $('#taskDetailModal').removeClass('hidden').addClass('flex');

                $.get('@Url.Action("MemberTasks", "Home")', { projectId, memberId, goalPeriod }, function (data) {
                    $('#modalContent').html(data);

                    // Initialize DataTable inside modal
                    if ($.fn.DataTable.isDataTable('#tasksTable')) {
                        $('#tasksTable').DataTable().destroy();
                    }
                    $('#tasksTable').DataTable({
                        paging: true,
                        searching: true,
                        ordering: true,
                        info: true,
                        pageLength: 10,
                        responsive: true,
                        columnDefs: [{ orderable: false, targets: [6, 7] }]
                    });
                });
            });


            // Close modal
            $('#closeModal').click(function () {
                $('#taskDetailModal').removeClass('flex').addClass('hidden');
                $('#modalContent').html('<p class="text-center text-gray-500">Loading...</p>');
            });
        });
    </script>
}

<style>
    /* Custom scrollbar for modal */
    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 9999px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #F0A500;
        border-radius: 9999px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #F0A500;
    }

    .custom-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: #F0A500 #f1f1f1;
    }
</style>